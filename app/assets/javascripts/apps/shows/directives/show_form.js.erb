/**
 * @ngdoc controller
 * @name ShowFormCtrl
 *
 * @description Logic for adding/editing shows
 */
(function() {
  "use strict";

var ShowFormCtrl = function( 
  $scope,
  ShowApp, Show
  ) {

  /**
   * Setup
   */

  /**
   * Watch variables
   */

  /**
   * Local methods
   */
  // Handle error response from server side
  var handleErrors = function(response) {
    if(response.data.full_errors) {
      $scope.notices.errors = response.data.full_errors;
    } else if(response.data.errors) {
      $scope.notices.errors = response.data.errors;
    } else if(response.status == 500) {
      $scope.notices.errors = ['Internal Server Error'];
    } else {
      $scope.notices.errors = ['An unknown error occurred'];
    }
  };

  /**
   * Scope methods
   */
  $scope.cancel = function() {
    // Clear current show
    $scope.currentShow = Show.build({});

    // Clear any errors
    $scope.notices = { errors: null };

    // Stop editing form
    $scope.editing = false;
  };

  // Shows the proper header prefix
  $scope.headingStr = function() {
    return $scope.currentShow.id ? 'Edit' : 'Create New';
  };

  // Saves the current show
  $scope.save = function() {
    // Check this before saving. After save it won't be new
    var newRecord = $scope.currentShow.isNewRecord();

    $scope.currentShow.save().then(function() {
      $scope.notices.successes = newRecord ? ['Successfully Created Show'] : ['Successfully Updated Show'];
      $scope.currentShow = Show.build({});
      $scope.editing = false;
    }).catch(handleErrors);
  };
};

ShowFormCtrl.$inject = [
  '$scope',
  'ShowApp', 'Show'
];

var ShowForm = function() {
  return {
    restrict: 'E',
    scope: {
      notices: '=',
      currentShow: '=',
      editing: '='
    },
    templateUrl: '<%= asset_path("apps/shows/templates/form.html") %>',
    controller: ShowFormCtrl
  };
};

angular.module("ShowApp")
       .directive('showForm', ShowForm);
}());
