/**
 * @ngdoc controller
 * @name IndexCtrl
 *
 * @description Controller for the index page of the videos app
 */
(function() {
  "use strict";

var IndexCtrl = function(
  $scope, $location, $routeParams,
  VideoApp, Video, Show, Notice, ApplicationConstants
  ) {
  /**
   * Setup
   */
  $scope.currentVideo = null;
  $scope.last_id = 0;
  $scope.page = 1;
  $scope.per_page = 10000;
  $scope.retrieving = true;
  $scope.show = Show.build({});
  $scope.videos = [];
  $scope.currentVideoOrder = [];
  $scope.showPreview = false;

  $scope.dispatcher = new WebSocketRails(ApplicationConstants.WEBSOCKET_URL);
  $scope.channel = $scope.dispatcher.subscribe('video_player');

  /**
   * Scope Methods
   */
  // Deletes a video from the queue
  $scope.destroy = function(video) {
    if(confirm("Are you sure you want to delete this video from the queue?\nThis cannot be undone.")){
      video.destroy().then(function() {
        $scope.videos = [];
        $scope.queryVideos();
      }).catch();
    }
  };

  $scope.playVideo = function(video){
    $scope.dispatcher.trigger('video_player.load', {
      video_id: video.id,
      player_id: 'broadcast',
      sender_id: 'video-' + video.id
    });
  };

  $scope.pauseVideo = function(video){
    $scope.dispatcher.trigger('video_player.pause', {
      video_id: video.id,
      player_id: 'broadcast',
      sender_id: 'video-' + video_id
    });
  };

  $scope.stopVideo = function(video){
    $scope.dispatcher.trigger('video_player.stop', {
      video_id: video.id,
      player_id: 'broadcast',
      sender_id: 'video-' + video_id
    });
  };

  $scope.channel.bind('play', function(message) {
    if(message.player_id == 'broadcast') {
      $scope.currentlyPlaying = message.video_id;
      $scope.$applyAsync();
    }
  });

  $scope.channel.bind('ready', function(message) {
    if(message.player_id == 'preview') {
      $scope.showPreview = true;
    };
  });

  $scope.channel.bind('stop', function(message) {
    if(message.player_id == 'preview') {
      $scope.showPreview = false;
    };
  });

  $scope.isCurrentlyPlaying = function(video) {
    return video.id == $scope.currentlyPlaying;
  };

  // Look up list of videos
  $scope.queryVideos = function(check_for_latest) {
    check_for_latest = check_for_latest || false;

    if($routeParams.show_id) {
      Show.find($routeParams.show_id).then(function(response) {
        $scope.show = Show.build(response.data);
        var params = {
          page: $scope.page,
          per_page: $scope.per_page,
          show_id: $routeParams.show_id,
          'q[s]': 'sort_order ASC'
        };

        // Just check for new videos
        if(check_for_latest) {
          params['q[id_gt]'] = $scope.last_id;
        }

        Video.query(params).then(function(response) {
          angular.forEach(response.data, function(video) {
            var newVideo = Video.build(video);
            $scope.videos.push(newVideo);
            $scope.currentVideoOrder.push(newVideo.id);
          });

          $scope.last_id = Math.max.apply(Math,$scope.videos.map(function(o){return o.id;}));

          $scope.retrieving = false;
        });
      }).catch(Notice.handleErrors);
    }
  };
  // Make actual lookup
  $scope.queryVideos();

  // Wrapper method for grabbing only new videos
  $scope.queryNewVideos = function() {
    $scope.queryVideos(true);
  };

  // Haw to save sort order
  $scope.sortableOptions = {
    stop: function(e, ui) {
      // this callback has the changed model
      var newVideoOrder = $scope.videos.map(function(o) {
        return o.id;
      });

      if(newVideoOrder.join() != $scope.currentVideoOrder.join()) {
        $scope.videos.map(function(o, i){
          o.sort_order = i;
          o.save();
        });
      }
    }
  };
};

IndexCtrl.$inject = [
  '$scope', '$location', '$routeParams',
  'VideoApp', 'Video', 'Show', 'Notice', 'ApplicationConstants'
];

angular.module("VideoApp")
       .controller('IndexCtrl', IndexCtrl);
}());
