/**
 * @ngdoc directive
 * @name VideoShow
 * @module VideoApp
 *
 * @description
 * This directive displays the video
 *
 * ### Usage
 * <video-show video="video"></video-show>
 */
(function() {
'use strict';

var controller = function(
  $scope,
  VideoApp, Video
) {
  /**
   * Setup
   */
  $scope.dispatcher = VideoApp.getDispatcher();
  $scope.channel = VideoApp.getChannel('video_player');
  $scope.playerId = VideoApp.getPlayerId('preview-' + $scope.video.show_id);
  $scope.senderId = $scope.senderId || 'video-' + $scope.video.id + '-' + Math.floor(Math.random() * 1000000);
  $scope.muted = true;
  $scope.playing = false;
  $scope.previewRequested = false;
  $scope.sliding = false;

  $scope.currentTime = 0;
  $scope.duration = 0;

  /**
   * Scope Methods
   */
  $scope.play = function() {
    if(!$scope.previewRequested) {
      $scope.previewRequested = true;
      $scope.dispatcher.trigger('video_player.play', {
        video: $scope.video,
        player_id: $scope.playerId,
        sender_id: $scope.senderId
      });
    }
  };

  $scope.stop = function() {
    $scope.dispatcher.trigger('video_player.stop', {
      player_id: $scope.playerId,
      sender_id: $scope.senderId
    });
  };

  $scope.mute = function() {
    $scope.toggleMute(true);
  };

  $scope.unMute = function() {
    $scope.toggleMute(false);
  };

  $scope.toggleMute = function(mute) {
    if($scope.playing) {
      var trigger = 'video_player.' + (mute ? "mute" : "unmute");
      $scope.dispatcher.trigger(trigger, {
        player_id: $scope.playerId,
        sender_id: $scope.senderId
      });

      //Success
      $scope.muted = mute;
      $scope.$applyAsync();
    }
  };

  $scope.startSlide = function(t) {
    $scope.sliding = true;
  };
  $scope.endSlide = function(t) {
    $scope.dispatcher.trigger('video_player.set_time', {
      video: $scope.video,
      player_id: $scope.playerId,
      sender_id: $scope.senderId,
      time: t
    });
  };

  /**
   * Event Handlers
   */
  $scope.channel.bind('playing', function(message) {
    if(message.player_id == $scope.playerId) {
      $scope.previewRequested = false;
      if(message.sender_id == $scope.senderId) {
        $scope.playing = true;
        $scope.$applyAsync();
      } else {
        $scope.playing = false;
        $scope.$applyAsync();
      }
    }
  });

  $scope.channel.bind('stopped', function(message) {
    if(message.sender_id == $scope.senderId) {
      $scope.previewRequested = false;
      $scope.playing = false;
      $scope.muted = true;
      $scope.$applyAsync();
    }
  });

  $scope.channel.bind('currently_playing', function(message) {
    if(message.sender_id == $scope.senderId) {
      $scope.previewRequested = false;
      $scope.playing = true;
      if(!$scope.sliding) {
        $scope.currentTime = message.current_time;
      }
      $scope.duration = message.duration;
      $scope.$applyAsync();
    }
  });

  $scope.channel.bind('set_time', function(message) {
    if(message.sender_id == $scope.senderId) {
      $scope.sliding = false;
    }
  });
};

controller.$inject = [
  '$scope',
  'VideoApp', 'Video'
];

var VideoShow = function() {
  return {
    restrict: 'E',
    scope: {
      video: '=',
      senderId: '='
    },
    controller: controller,
    templateUrl: '<%= asset_path("apps/videos/templates/video_show.html") %>'
  };
};

angular.module('VideoApp')
       .directive('videoShow', VideoShow);
}());

