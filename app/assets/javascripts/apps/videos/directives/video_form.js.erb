/**
 * @ngdoc directive
 * @name VideoForm
 * @module VideoApp
 *
 * @description
 * This directive displays the add video form
 *
 * ### Usage
 * <video-form></video-form>
 */
(function() {
'use strict';

var controller = function(
  $scope, $routeParams, $timeout,
  VideoApp, Video, Notice, YoutubeParser
) {
  /**
   * Setup
   */
  $scope.show_id = $routeParams.show_id;
  $scope.dispatcher = VideoApp.getDispatcher();
  $scope.channel = VideoApp.getChannel('video_player');
  $scope.currentVideo = Video.build({show_id: $scope.show_id});
  var searchTimeout;

  /**
   * Watched variables
   */
  $scope.$watch('currentVideo.search', function(newVal, oldVal) {
    if(newVal == '') {
      // Clear current video if we clear the search
      $scope.currentVideo = Video.build({show_id: $scope.show_id});
    }

    if(newVal && newVal != oldVal) {
      if(searchTimeout) {
        $timeout.cancel(searchTimeout);
      }

      searchTimeout = $timeout(function() {
        // Lookup youtube video
        YoutubeParser.query(newVal).then(function(response) {
          var yt = YoutubeParser.build(response.data);

          // Store the data on the current video object
          $scope.currentVideo.setFromYoutubeParser(yt);
        });
      }, 250);
    }
  });

  /**
   * Scope Methods
   */
  $scope.save = function() {
    $scope.currentVideo.save().then(function() {
      $scope.currentVideo = Video.build({ show_id: $scope.show_id});

      // This is called on the parent controller.
      // Is defined in the scope section below
      $scope.closeForm();
      $scope.queryNewVideos();
    }).catch(Notice.handleErrors);
  };

  $scope.cancel = function() {
    $scope.dispatcher.trigger('video_player.stop', {
      video: $scope.currentVideo,
      player_id: 'preview',
      force: true
    });
    Notice.reset();
    $scope.closeForm();
    $scope.currentVideo = Video.build({ show_id: $scope.show_id });
  };
};

controller.$inject = [
  '$scope', '$routeParams', '$timeout',
  'VideoApp', 'Video', 'Notice', 'YoutubeParser'
];

var VideoForm = function() {
  return {
    restrict: 'E',
    scope: {
      queryNewVideos: '&',
      closeForm: '&'
    },
    controller: controller,
    templateUrl: '<%= asset_path("apps/videos/templates/video_form.html") %>'
  };
};

angular.module('VideoApp')
       .directive('videoForm', VideoForm);
}());

