/**
 * @ngdoc directive
 * @name VideoPreview
 * @module shared
 *
 * @description
 * This directive displays the video
 *
 * ### Usage
 * <video-preview video="video"></video-preview>
 */
(function() {
'use strict';

var controller = function(
  $scope, $sce,
  Video
) {
  /**
   * Setup
   */
  $scope.dispatcher = new WebSocketRails('localhost:3000/websocket');
  $scope.channel = $scope.dispatcher.subscribe('video_player');

  /**
   * Scope Methods
   */
  $scope.channel.bind('play', function(message) {
    $scope.player.playVideo();
  });

  $scope.ready = function() {
    $scope.dispatcher.trigger('video_player.ready', {});
  };
};

controller.$inject = [
  '$scope', '$sce',
  'Video'
];

var VideoPreview = function($window) {
  return {
    restrict: 'E',
    scope: {
      video: '='
    },
    controller: controller,
    templateUrl: '<%= asset_path("apps/shared/templates/video_preview.html") %>',
    link: function($scope, $element, $attrs, $controller) {
      var tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      $window.onYouTubeIframeAPIReady = function() {
        $scope.player = new YT.Player($element.find('.video_preview').get(0), {
          videoId: $scope.video.api_video_id,
          autoplay: 0,
          html5: 1,
          theme: "light",
          modesbranding: 0,
          color: "white",
          iv_load_policy: 3,
          showinfo: 0,
          controls: 1,
          rel: 0,
          start: $scope.video.start_time,
          end: $scope.video.end_time,
          events: {
            'onReady': function() {
              $scope.ready();
            }
          }
        });
      };
    }
  };
};

angular.module('shared')
       .directive('videoPreview', VideoPreview);
}());
