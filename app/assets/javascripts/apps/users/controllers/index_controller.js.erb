/**
 * @ngdoc controller
 * @name IndexCtrl
 *
 * @description Logic for index stuffs
 */
(function() {
  "use strict";

var IndexCtrl = function(
  $scope, $location,
  UserApp, User, CurrentUser, Notice
  ) {

  /**
   * Setup
   */
  $scope.retrieving = false;
  $scope.users = [];
  CurrentUser.find().then(function(results) {
    $scope.currentUser = CurrentUser.build(results.data);
  });

  /**
   * Watch variables
   */

  /**
   * Scope methods
   */
  $scope.authorize = function(user) {
    user.authorize().catch(Notice.handleErrors);
  };

  $scope.deAuthorize = function(user) {
    if(confirm("Are you sure you want to de-authorize this user?\nThey will no longer be allowed to sign in.")){
      user.deAuthorize().catch(Notice.handleErrors);
    }
  };

  $scope.edit = function(user) {
    $location.path('/' + user.id + '/edit');
  };

  // Get all users
  $scope.fetchUsers = function() {
    if(!$scope.retreiving) {
      $scope.retrieving = true;
      $scope.users = []; 
      $scope.queryUsers();
    }
  };

  // Looks up users 
  $scope.queryUsers = function() {
    // Skip if we're currently looking up users
    if($scope.querying) { return true; }

    $scope.querying = true;

    var params = {};

    // Lookup campaigns based on params
    User.query(params).then(function(response) {
      angular.forEach(response.data, function(user) {
        $scope.users.push(User.build(user));
      });
      $scope.retrieving = false;
      $scope.querying = false;
    });
  };

  // Lookup initial list of users
  $scope.fetchUsers();
};

IndexCtrl.$inject = [
  '$scope', '$location',
  'UserApp', 'User', 'CurrentUser', 'Notice'
];

angular.module("UserApp")
       .controller('IndexCtrl', IndexCtrl);
}());
